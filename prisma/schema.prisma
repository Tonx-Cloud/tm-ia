// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String        @id
  email     String        @unique
  credits   Int           @default(0)
  createdAt DateTime      @default(now())
  projects  Project[]
  creditsLog CreditEntry[]
}

model CreditEntry {
  id        String   @id @default(uuid())
  userId    String
  type      String   // earn | spend
  amount    Int
  reason    String
  projectId String?
  renderId  String?
  assetId   String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Project {
  id            String   @id @default(uuid())
  userId        String?
  name          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Audio
  audioUrl      String?
  audioPath     String?
  audioFilename String?
  audioMime     String?
  audioData     String?  // Base64 fallback if Blob fails

  // Assets & Storyboard
  storyboard    String   @default("[]") // JSON string of StoryboardItem[]

  // Meta
  mood          String?
  style         String?
  aspectRatio   String?

  user          User?    @relation(fields: [userId], references: [id])
  assets        Asset[]
  renders       Render[]

  @@index([userId])
}

model Asset {
  id          String   @id @default(uuid())
  projectId   String
  createdAt   DateTime @default(now())

  prompt      String
  status      String   @default("generated") // generated, reused, needs_regen
  dataUrl     String

  // Audit / naming
  fileKey     String?  // e.g. tmia__<project>__YYYYMMDD-HHmmss__s03__a1b2c3d4

  // Metadata
  sceneNumber Int?
  timeCode    String?
  lyrics      String?
  visualNotes String?

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Render {
  id           String   @id @default(uuid())
  projectId    String
  userId       String?
  configId     String?  // inline, etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  status       String   // pending, processing, complete, failed
  progress     Int      @default(0)
  outputUrl    String?
  error        String?
  logTail      String?
  costCredits  Int?

  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId, createdAt])
}

model ImageJob {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  assetId   String
  modelId   String
  status    String   // pending, processing, complete, failed
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}
